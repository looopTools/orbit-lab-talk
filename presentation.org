#+TITLE: Data Storage - When reality clashes with theory
#+AUTHOR: Lars Nielsen, /Postdoctoral Researcher/  

#+OPTIONS: TeX:t LaTeX:t skip:nil d:nil toc:nil title:nil date:nil

#+startup: beamer
#+LaTeX_CLASS: beamer
#+LaTeX_CLASS_OPTIONS: [table,svgnames,aspectratio=169]
#+latex_header: \input{preamble}

\input{title_slide}

* 

  #+BEGIN_CENTER
#+latex: {\huge Researchers are often guilty of only celebratint the final success}
  #+END_CENTER

  #+BEGIN_CENTER
#+latex: {\huge I want to present the carnage that can happen behind the scene}
  #+END_CENTER  

* The Research Goal

  #+BEGIN_CENTER
#+latex:  {\huge To create a file system based on a new emerging technology called generalised deduplication}
  #+END_CENTER


* The carnage

  #+BEGIN_CENTER
#+latex: {\huge We constantly ran out of disk space}
  #+END_CENTER

  #+BEGIN_CENTER
#+latex: {\huge But all analytics tools told us that we had amble space left}
  #+END_CENTER  

  #+BEGIN_CENTER
#+latex: {\huge So what was wrong?}
  #+END_CENTER  


* Research Vectors

** Left                                                               :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:
- Our code
- Some thing out side our code

** Right                                                              :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:

* Research Vectors

** Left                                                               :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:
- Our code
- Some thing out side our code 
   

** Right                                                              :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:
- Our code
  - Full code analysis revealed, exactly nothing
  - Follow systems calls, revealed... well nothing

* Research Vectors

** Left                                                               :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:
- Our code
- Some thing out side our code 
   

** Right                                                              :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:
- Something outside our code
  - We used EXT4 as an external storage
    - It has something called a directory index

* EXT 4 Directory index 

  - An index of all files in a folder
  - It is (most often) loaded in to memory
  - Used to speed up look up operations
    - \texttt{ls}, \texttt{stat}, etc.

* EXT 4 Directory index 

** Left                                                               :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:
  - An index of all files in a folder
  - It is (most often) loaded in to memory
  - Used to speed up look up operations
    - \texttt{ls}, \texttt{stat}, etc.

** Right                                                              :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:

#+BEGIN_CENTER
#+latex: {\large So what is the problem?}
#+END_CENTER

* EXT4 vs Directory Index

#+BEGIN_CENTER
#+latex: {\huge EXT4 can in theory stored an "unlimited" amount of files}  
#+END_CENTER

#+BEGIN_CENTER
#+latex: {\huge Directory Index has a different limit}  
#+END_CENTER

* EXT4 vs Directory Index

#+BEGIN_CENTER
#+latex: {\huge EXT4 can in theory stored an "unlimited" amount of files}  
#+END_CENTER

#+BEGIN_CENTER
#+latex: {\huge Directory Index has a different limit}  
#+END_CENTER

#+BEGIN_CENTER
#+latex: {\huge Relax it gets worse the limit varies between Linux distributions and even version.} 
#+END_CENTER
  

* The problem

  - Directory Index limits a system that should be limited
  - The limit is not well defined

    |---------------------+----------------|
    | OS                  | Observed limit |
    |---------------------+----------------|
    |---------------------+----------------|
    | Ubuntu 18.04        | 12mio          |
    | Ubuntu 18.04 server | 16mio          |
    | Fedora 31           | 32mio          |
    | Fedora 31 Server    | 32mio          |
    | Ubuntu 20.04        | 20mio          |
    | Fedora 33           | 64mio          |

* Solutions

  - Disable the directory index 
    - That is an option
    - It solves the issue
    - But it heavily damage performance

* Solutions

** Left                                                               :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:

  - Disable the directory index 
    - That is an option
    - It solves the issue
    - But it heavily damage performance

** Right                                                              :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:

   - So let us hack away around
   - We will turn the disadvantage of directory index into an advantage
   - It is only a "solution"

* Hackaround

  - Our file all have a SHA-1 identifier
    - 20 bytes or converted to hexadecimal string 40 bytes

  Let us use that to create a grouping system 

* Hackaround

  - Our file all have a SHA-1 identifier
    - 20 bytes or converted to hexadecimal string 40 bytes

#+latex: \resizebox{\linewidth}{!}{\input{graphics/hash}}
      
  Let us use that to create a grouping system 

#+latex: \resizebox{\linewidth}{!}{\input{graphics/hash_group_1}}  

If hash for files shares the 2 first characters they belong to the same /major group/

#+latex: \resizebox{\linewidth}{!}{\input{graphics/hash_group_2}}

and say files that shares the first 4 characters belongs to the same /minor group/

  
* Hackaround

  #+latex: \resizebox{\linewidth}{!}{\input{graphics/hash_group_2}}

** Left                                                               :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:

  - Then we create a folder for each major group
  - In the major group we create folders for all minor groups
  - Then we place all files belong to that specific minor group in folder

** Right                                                              :BMCOL:
   :PROPERTIES:
   :BEAMER_col: .5
   :END:

   - Make structure picture

* Hackaround

  What this does is:
  - Reduce the probability of hitting the directory index limit
    - all though still present
  - But we retain the power of the directory index
  - With minimum damage to storage usage
    4kB (minimum per folder) 
